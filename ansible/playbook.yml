---
- name: Configure EC2 nodes and run application
  hosts: ec2_nodes
  become: yes
  gather_facts: false

  tasks:

    - name: Install Python3, pip3 and Docker
      raw: |
        if command -v yum >/dev/null 2>&1; then
          sudo yum install -y python3 python3-pip docker
        elif command -v dnf >/dev/null 2>&1; then
          sudo dnf install -y python3 python3-pip docker
        elif command -v apt-get >/dev/null 2>&1; then
          sudo apt-get update -y
          sudo apt-get install -y python3 python3-pip docker.io
        fi

    - name: Enable and start Docker service
      raw: |
        sudo systemctl enable docker || true
        sudo systemctl start docker || true

    - name: Pull and run bank-app container
      raw: |
        sudo docker pull 04unit04/final-devops-bank-app:latest
        if sudo docker ps -a --format '{{.Names}}' | grep -q '^bank-app$'; then
          sudo docker rm -f bank-app
        fi
        sudo docker run -d --name bank-app -p 80:80 --restart=always 04unit04/final-devops-bank-app:latest
